<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>
        데이터 시각화
    </title>
    <!--     Fonts and icons     -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,600,700,800" rel="stylesheet" />
    <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
    <!-- Nucleo Icons -->
    <link href="../static/assets/css/nucleo-icons.css" rel="stylesheet" />
    <!-- CSS Files -->
    <link href="../static/assets/css/black-dashboard.css?v=1.0.0" rel="stylesheet" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="jquery.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <style>
        div.row2 {
            position: relative;
            column-count: 2;
        }
        .legend rect {
            position: relative;
            fill:white;
            stroke:black;
            opacity:0.8;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <div class="sidebar">
            <ul class="nav">
                <li>
                    <a href="./">
                        <i class="tim-icons icon-notes"></i>
                            <p>Introduction</p>
                    </a>
                </li>
                <li>
                    <a href="./fileUpload">
                        <i class="tim-icons icon-cloud-upload-94"></i>
                            <p>File Upload</p>
                    </a>
                </li>
                <li>
                    <a href="./machineLearning">
                        <i class="tim-icons icon-spaceship"></i>
                            <p>Machine Learning</p>
                    </a>
                </li>
                <li class="active ">
                    <a href="./visualization">
                        <i class="tim-icons icon-molecule-40"></i>
                            <p>Data Visualization</p>
                    </a>
                </li>
            </ul>
        </div>
        <div class="main-panel">
            <div class="content">
                <div class="row1">
                    <div class="col-12">
                        <div class="card card-chart">
                            <div class="card-header ">
                                <div class="row">
                                    <div class="col-sm-6 text-left">
                                        <h4 class="card-category" style="font-size:14px">Daumsoft AI LAB</h4>
                                        <h2 class="card-title">Visualization</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row2">
                    {% if visualization == 'embedding_and_visualization' %}
                        <div class="flex-column" id="area1"></div>
                        <div class="flex-column" id="area2"></div>
                    {% elif visualization == 'embedding_and_machineLearning_visualization' %}
                        <div class="flex-column" id="area3"></div>
                        <div class="flex-column" id="area4"></div>
                        <div class="flex-column" id="area5"></div>
                        <div class="flex-column" id="area6"></div>
                        <div class="flex-column" id="area7"></div>
                        <div class="flex-column" id="area8"></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <script class="a1">
        // set the dimensions and margins of the graph
        var margin2 = {top: 10, right: 30, bottom: 40, left: 50},
            width2 = 450 - margin2.left - margin2.right,
            height2 = 450 - margin2.top - margin2.bottom;

        // append the SVg object to the body of the page
        var SVG2 = d3.select("#area1")
            .style("background-color", "none")
            .append("svg")
            .attr("width", width2 + margin2.left + margin2.right)
            .attr("height", height2 + margin2.top + margin2.bottom)
            .append("g")
            .attr("transform",
            "translate(" + margin2.left + "," + margin2.top + ")")

        // Add the black box around the chart
        SVG2
            .append("rect")
            .attr("x",0)
            .attr("y",0)
            .attr("height", height2)
            .attr("width", height2)
            .style("fill", "none")
            .style("stroke", "black")
            .style("opacity", 0.6)

        //Read the data
        d3.csv("http://127.0.0.1:8080/embedding_and_visualization_1", function(data) {

            // Add X axis
            var x = d3.scaleLinear()
                .domain([-2, 8])
                .range([ 0, width2 ])
                SVG2.append("g")
                .attr("transform", "translate(0," + height2 + ")")
                .call(d3.axisBottom(x))

            // Add Y axis
            var y = d3.scaleLinear()
                .domain([-3, 8])
                .range([ height2, 0])
                .nice()
                SVG2.append("g")
                .call(d3.axisLeft(y))

            // Add X axis label:
            SVG2.append("text")
                .attr("text-anchor", "end")
                .attr("x", width2)
                .attr("y", height2 + margin2.top + 20)
                .text("dimension 0")
                .style("fill", "white")

            // Y axis label:
            SVG2.append("text")
                .attr("text-anchor", "end")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin2.left+20)
                .attr("x", -margin2.top)
                .text("dimension 1")
                .style("fill", "white")

            // Customization
            SVG2.selectAll(".tick line").attr("stroke", "white")
            SVG2.selectAll(".tick text").attr("stroke", "white").style("font-size", 10)

            var target_names = new Set();

            for (var i = 0; i < data.length; i++) {
                console.log(data[i]['pred']);
                target_names.add(data[i]['pred'])
            }
            console.log(target_names)
            target_names = Array.from(target_names).sort();
            console.log(target_names)

            var color = d3.scaleOrdinal()
                .domain(target_names)
                .range(d3.schemeCategory10)

            // Add dots
            SVG2.append('g')
                .selectAll("dot")
                .data(data)
                .enter()
                .append("circle")
                .attr("cx", function (d) { return x(d.pca0); } )
                .attr("cy", function (d) { return y(d.pca1); } )
                .attr("r", 2)
                .attr("data-legend",function(d) { return d.pred})
                .style("fill", function (d) { return color(d.pred) } )
                .style("stroke", "white")
                .style("stroke-width", 1)

            var keys = Array.from(target_names)

            SVG2.append("g")
                .selectAll("legend")
                .data(keys)
                .enter()
                .append("circle")
                    .attr("cx", -margin2.left + 70)
                    .attr("cy", function(d, i) { return 15 + i * 25 })
                    .attr("r", 2)
                    .style("fill", function(d) { return color(d) })
                    .attr("stroke", "white")
                    .style("stroke-width", 1)

            SVG2.append("g")
                .selectAll("labels")
                .data(keys)
                .enter()
                .append("text")
                    .attr("x", -margin2.left + 80)
                    .attr("y", function(d, i) { return 15 + i * 25 })
                    .style("fill", function(d) { return color(d) })
                    .text(function(d) { return d })
                    .attr("text-anchor", "left")
                    .attr("stroke", "white")
                    .style("stroke-width", 1)
                    .style("alignment-baseline", "middle")
        })
    </script>
    <script class="a2">
        // set the dimensions and margins of the graph
        var margin = {top: 10, right: 30, bottom: 40, left: 50},
            width = 450 - margin.left - margin.right,
            height = 450 - margin.top - margin.bottom;

        // append the SVg object to the body of the page
        var SVG = d3.select("#area2")
            .style("background-color", "none")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")")

        // Add the black box around the chart
        SVG
            .append("rect")
            .attr("x",0)
            .attr("y",0)
            .attr("height", height)
            .attr("width", height)
            .style("fill", "none")
            .style("stroke", "black")
            .style("opacity", 0.6)

        //Read the data
        d3.csv("http://127.0.0.1:8080/embedding_and_visualization_2", function(data) {

            // Add X axis
            var x = d3.scaleLinear()
                .domain([-2, 8])
                .range([ 0, width ])
                SVG.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x))

            // Add Y axis
            var y = d3.scaleLinear()
                .domain([-3, 8])
                .range([ height, 0])
                .nice()
                SVG.append("g")
                .call(d3.axisLeft(y))

            // Add X axis label:
            SVG.append("text")
                .attr("text-anchor", "end")
                .attr("x", width)
                .attr("y", height + margin.top + 20)
                .text("dimension 0")
                .style("fill", "white")

            // Y axis label:
            SVG.append("text")
                .attr("text-anchor", "end")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left+20)
                .attr("x", -margin.top)
                .text("dimension 1")
                .style("fill", "white")

            // Customization
            SVG.selectAll(".tick line").attr("stroke", "white")
            SVG.selectAll(".tick text").attr("stroke", "white").style("font-size", 10)

            var target_names = new Set();

            for (var i = 0; i < data.length; i++) {
                console.log(data[i]['target']);
                target_names.add(data[i]['target'])
            }
            console.log(target_names)
            target_names = Array.from(target_names).sort();
            console.log(target_names)

            var color = d3.scaleOrdinal()
                .domain(target_names)
                .range(d3.schemeCategory10)

            // Add dots
            SVG.append('g')
                .selectAll("dot")
                .data(data)
                .enter()
                .append("circle")
                .attr("cx", function (d) { return x(d.pca0); } )
                .attr("cy", function (d) { return y(d.pca1); } )
                .attr("r", 2)
                .attr("data-legend",function(d) { return d.target})
                .style("fill", function (d) { return color(d.target) } )
                {#.style("stroke", "white")#}
                {#.style("stroke-width", 1)#}

            var keys = Array.from(target_names)

            SVG.append("g")
                .selectAll("legend")
                .data(keys)
                .enter()
                .append("circle")
                    .attr("cx", -margin.left + 70)
                    .attr("cy", function(d, i) { return 15 + i * 25 })
                    .attr("r", 2)
                    .style("fill", function(d) { return color(d) })
                    {#.attr("stroke", "white")#}
                    {#.style("stroke-width", 1)#}

            SVG.append("g")
                .selectAll("labels")
                .data(keys)
                .enter()
                .append("text")
                    .attr("x", -margin.left + 80)
                    .attr("y", function(d, i) { return 15 + i * 25 })
                    .style("fill", function(d) { return color(d) })
                    .text(function(d) { return d })
                    .attr("text-anchor", "left")
                    {#.attr("stroke", "white")#}
                    {#.style("stroke-width", 1)#}
                    .style("alignment-baseline", "middle")

        })
    </script>
    <script class="a3">
        var margin = {top: 80, right: 25, bottom: 30, left: 40},
            width = 450 - margin.left - margin.right,
            height = 450 - margin.top - margin.bottom;

        var svg = d3.select("#area3")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        d3.csv("http://127.0.0.1:8080/metrics_score", function(data) {

            var x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(function(d) { return d.Metrics; }))
                .padding(0.2);

            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(10, 0)rotate(-45)")
                .style("text-anchor", "end")

            var y = d3.scaleLinear()
                .domain([0, 1.0])
                .range([height, 0]);

            svg.append("g")
                .call(d3.axisLeft(y));

            var color = d3.scaleOrdinal()
                .range([`#dc6750`, `#c5dc50`, `#50c5dc`, `#6750dc`])

            var tooltip = d3.select("#score")
                .append("div")
                .style("opacity", 0)
                .attr("class", "tooltip")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "1px")
                .style("border-radius", "5px")
                .style("padding", "10px")
                .style("width", "80px")

            var mouseover = function(d) {
                tooltip
                .style("opacity", 1)
                d3.select(this)
                .style("stroke", "black")
                .style("opacity", 1)
            }

            var mousemove = function(d) {
                tooltip.html("score: " + d.Score)
                .style("left", (d3.mouse(this)[0]+70) + "px")
                .style("top", (d3.mouse(this)[1]) + "px")
            }

            var mouseleave = function(d) {
                tooltip.style("opacity", 0)
                d3.select(this)
                .style("stroke", "none")
                .style("opacity", 0.8)
            }

            svg.selectAll("mybar")
                .data(data)
                .enter()
                .append("rect")
                .attr("x", function(d) { return x(d.Metrics); })
                .attr("width", x.bandwidth())
                .attr("fill", "#69b3a2")
                .attr("height", function(d) { return height - y(0); })
                .attr("y", function(d) { return y(0); })

            svg.selectAll("rect")
                .attr("y", function(d) { return y(d.Score); })
                .attr("height", function(d) { return height - y(d.Score); })
                .attr("width", x.bandwidth())
                .attr("fill", function(d) { return color(d.Metrics); })
                .attr("stroke", "grey")
                .on("mouseover", mouseover)
                .on("mousemove", mousemove)
                .on("mouseleave", mouseleave)
        })
    </script>
    <script class="a4">
        var margin2 = {top: 80, right: 25, bottom: 30, left: 40},
            width2 = 450 - margin2.left - margin2.right,
            height2 = 450 - margin2.top - margin2.bottom;

        var svg2 = d3.select("#area4")
            .append("svg")
            .attr("width", width2 + margin2.left + margin2.right)
            .attr("height", height2 + margin2.top + margin2.bottom)
            .append("g")
            .attr("transform",
            "translate(" + margin2.left + "," + margin2.top + ")");

        // confusion_matrix URI로부터 데이터를 얻어옴
        d3.csv("http://127.0.0.1:8080/confusion_matrix", function(data) {

            var myGroups = d3.map(data, function(d){return d.group;}).keys()
            var myVars = d3.map(data, function(d){return d.variable;}).keys()

            var x = d3.scaleBand()
                .range([0, width2])
                .domain(myGroups)
                .padding(0.05);

            svg2.append("g")
                .style("font-size", 15)
                .attr("transform", "translate(0," + height2 + ")")
                .call(d3.axisBottom(x).tickSize(0))
                .select(".domain").remove()

            var y = d3.scaleBand()
                .range([height2, 0])
                .domain(myVars)
                .padding(0.05);

            svg2.append("g")
                .style("font-size", 15)
                .call(d3.axisLeft(y).tickSize(0))
                .select(".domain").remove()

            var myColor = d3.scaleSequential()
                .interpolator(d3.interpolateMagma)
                .domain([1, 1000])

            var tooltip = d3.select("#heatmap")
                .append("div")
                .style("opacity", 0)
                .attr("class", "tooltip")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "2px")
                .style("border-radius", "5px")
                .style("padding", "5px")
                .style("width", "80px")

            var mouseover = function(d) {
                tooltip.style("opacity", 1)
                d3.select(this)
                .style("stroke", "black")
                .style("opacity", 1)
        }

        var mousemove = function(d) {
            tooltip.html(d.value)
            .style("left", (d3.mouse(this)[0]+70) + "px")
            .style("top", (d3.mouse(this)[1]) + "px")
        }
        var mouseleave = function(d) {
            tooltip.style("opacity", 0)

        d3.select(this)
            .style("stroke", "none")
            .style("opacity", 0.8)
        }

        svg2.selectAll()
            .data(data, function(d) {return d.group+':'+d.variable;})
            .enter()
            .append("rect")
            .attr("x", function(d) { return x(d.group) })
            .attr("y", function(d) { return y(d.variable) })
            .attr("rx", 4)
            .attr("ry", 4)
            .attr("width", x.bandwidth() )
            .attr("height", y.bandwidth() )
            .style("fill", function(d) { return myColor(d.value)} )
            .style("stroke-width", 4)
            .style("stroke", "none")
            .style("opacity", 0.8)
            .on("mouseover", mouseover)
            .on("mousemove", mousemove)
            .on("mouseleave", mouseleave)
        })

        svg2.append("text")
            .attr("x", 0)
            .attr("y", -50)
            .attr("text-anchor", "left")
            .style("font-size", "22px")

        svg2.append("text")
            .attr("x", 0)
            .attr("y", -20)
            .attr("text-anchor", "left")
            .style("font-size", "14px")
            .style("fill", "grey")
            .style("max-width", 400)
            .text("Confusion Matrix");
    </script>
    <div id="a5">
        <script>
            var margin = {top: 10, right: 30, bottom: 30, left: 60},
                width = 460 - margin.left - margin.right,
                height = 400 - margin.top - margin.bottom;

            var svg = d3.select("#area5")
                        .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform",
                        "translate(" + margin.left + "," + margin.top + ")");

            d3.csv("http://127.0.0.1:8080/precision_recall_data",function(data) {

                // Add X axis
                var x = d3.scaleLinear()
                    .domain([0, 1.0])
                    .range([ 0, width ]);
                    svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x));

                // Add Y axis
                var y = d3.scaleLinear()
                    .domain([0, 1.0])
                    .range([ height, 0 ]);
                    svg.append("g")
                    .call(d3.axisLeft(y));

                svg.append("path")
                    .datum(data)
                    .attr("fill", "#cce5df")
                    .attr("stroke", "steelblue")
                    .attr("stroke-width", 3.5)
                    .attr("d", d3.area()
                    .x(function(d) { return x(d.x) })
                    .y0(function(d) { return y(d.CI_left) })
                    .y1(function(d) { return y(d.CI_right) }))
            })
        </script>
    </div>
</body>
</html>